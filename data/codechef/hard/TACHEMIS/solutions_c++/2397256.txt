#include <algorithm>
#include <iostream>
#include <sstream>
#include <string>
#include <vector>
#include <queue>
#include <stack>
#include <set>
#include <map>
#include <list>
#include <bitset>
#include <deque>
#include <numeric>
#include <iterator>
#include <cstdio>
#include <cstdlib>
#include <cstring>
#include <cctype>
#include <cmath>
#include <climits>
 
using namespace std;
 
#define SZ(a) int(a.size())
vector<long long> manachers(const vector<long long> &A)
{
	vector<long long> S;
	for(int i = 0; i < SZ(A); ++i)
	{
		S.push_back(2000000000);
		S.push_back(A[i]);
	}
	S.push_back(2000000000);
	vector<long long> P(S.size());
	long long ma = 0;
	P[0] = 0;
	for(int i = 1; i < SZ(P) ; ++i)
	{
		if( P[ma]+ma >= i)
			P[i] = min( P[2*ma-i] , 2*ma-i-(ma-P[ma]));
		long long lo = i - P[i]-1, hi = i + P[i]+1;
		while(lo >= 0 && hi < SZ(P) && S[lo]==S[hi])
			P[i]++, lo--, hi++;
		if( P[ma]+ma < P[i]+i )
			ma = i;
	}
	return P;
}
 
int main() 
{
	int TC;
	scanf("%d",&TC);
	while(TC-->0)
	{
		int N;
		scanf("%d",&N);
		vector<long long> A(N);
		vector<long long> B(N);
		vector<long long> ACU(N);
		for (int i = 0; i < N; ++i) {
			char c[2];
			scanf("%s%d",c,&B[i]);
			A[i] = c[0];
			if(i>0)ACU[i] = ACU[i-1] + B[i];
			else ACU[i] = B[i];
		}
		vector<long long> PA = manachers(A);
		vector<long long> PB = manachers(B);
		vector<long long> PC(PA.size());
		for (int i = 0; i < PB.size(); ++i) {
			PC[i] = min(PA[i],PB[i]);
	//		cout << PA[i] << " " << PB[i] << " " << ((i&1) ? char(A[i/2]) : '#')<< endl;
		}
		
		long long tot = 0;
		for (int i = 1; i < PC.size()-1; ++i) {
			if(i&1)
			{
				long long b = (B[i/2] * (B[i/2]+1))/2 - (B[i/2]+1)/2;
				
				
				long long lo = i/2 - PC[i]/2 , hi = i/2 + PC[i]/2;
				long long t = ACU[hi];
				if(lo > 0)t -= ACU[lo-1];
				if(lo > 0 && hi < N-1)
				{
					if( A[lo-1] == A[hi+1] )
						t += 2*min(B[lo-1],B[hi+1]);
				}
				tot += (t+1)/2 + b;
			}
		}
		printf("%lld\n",tot);
	}
	
	
}
