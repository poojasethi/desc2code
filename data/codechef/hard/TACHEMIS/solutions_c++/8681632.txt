#include <bits/stdc++.h>
#define filein(t) freopen(t, "r", stdin)
#define fileout(t) freopen(t, "w", stdout)
#define ll long long
#define ull unsigned long long
#define mp make_pair
#define f first
#define s second
#define N 250007
#define cs 1373
#define BIT(i, n) ( (n >> i) & 1 )
#define ln 100000000000000000
#define oo 1000000007
#define Pa pair <int, int>

using namespace std;

pair <char, int> C[N];
ll Sum[N];
int n, DP[N];

int main()
{
   // filein("TACHEMIS.inp"); fileout("TACHEMIS.out");
    int T;
    cin >> T;
    while(T--)
    {
        int pos = 0, R = 0;
        ll ans = 0;
        cin >> n;
        for(int i=1; i<=n; i++)
        {
            cin >> C[i].f >> C[i].s;
            Sum[i] = Sum[i-1] + C[i].s;
        }
        C[n+1] = mp('{', 0);
        for(int i=1; i<=n; i++)
        {
            int k = (i > R ? 0 : min(DP[2*pos-i], R-i)) ;
            while(C[i-k] == C[i+k] && i-k>=1 && i+k<=n) k++;
            DP[i] = --k;
            if(i + DP[i] > R)
            {
                pos = i;
                R = i + DP[i];
            }
        }
        for(int i=1; i<=n; i++)
        {
            ll num = Sum[i+DP[i]] - Sum[i-DP[i]-1];
            if(C[i-DP[i]-1].f == C[i+DP[i]+1].f)
                num += 2 * min(C[i-DP[i]-1].s, C[i+DP[i]+1].s);
            ans += (ll)C[i].s * (C[i].s + 1) / 2 + (num-C[i].s) / 2;
        }
        cout << ans << endl;
    }
}
