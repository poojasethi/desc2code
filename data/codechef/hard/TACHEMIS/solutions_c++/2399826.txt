#include<stdio.h>
#include<algorithm>
using namespace std;
long long t,n,i,c,r,im,sum,cnt[1000005],ans[1000005],p[1000005],sum1[1000005];
char s[1000005],ch[100];
int main()
{
    scanf("%d",&t);
    while(t--)
    {
        scanf("%d",&n);
        sum=0;
        s[0]='^';
        for(i=1;i<=n;i++)
        {
            scanf("%s %d",&ch,&cnt[i]);
            s[i]=ch[0];
            ans[i]=(cnt[i]*(cnt[i]+1))/2;
            sum1[i]=sum1[i-1]+cnt[i];
        }
        s[i]='$';
        c=0;
        r=0;
        for(i=1;i<=n;i++)
        {
            im=2*c-i;
            if(im<0)
            im=0;
            p[i]=((r>i)?min(p[im],r-i):0);
            while(s[i-p[i]-1]==s[i+p[i]+1] && cnt[i-p[i]-1]==cnt[i+p[i]+1])
            p[i]++;
            if(i+p[i]>r)
            {
                c=i;
                r=i+p[i];
            }
        }
        for(i=1;i<=n;i++)
        {
            if(p[i]==0)
            {
                if(s[i-1]==s[i+1])
                ans[i]=ans[i]+min(cnt[i-1],cnt[i+1]);

            }
            else
            {
                ans[i]=ans[i]+sum1[i-1]-sum1[i-p[i]-1];
                if(s[i-p[i]-1]==s[i+p[i]+1])
                ans[i]=ans[i]+min(cnt[i-p[i]-1],cnt[i+p[i]+1]);
            }
        }
        for(i=1;i<=n;i++)
        sum=sum+ans[i];
        printf("%lld\n",sum);
        for(i=0;i<=n;i++)
        {
            p[i]=0;
            sum1[i]=0;
            ans[i]=0;
            s[i]=0;
            cnt[i]=0;
        }
    }
    return 0;
}
