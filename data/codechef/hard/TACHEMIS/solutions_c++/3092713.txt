#include<iostream>
#include<vector>
#include<string.h>
#include<stdio.h>
#include<math.h>
#include<algorithm>
#define LL long long
#define P(N) printf("%d\n",N);
#define S(N) scanf("%d",&N);
#define SL(N) scanf("%lld",&N);
#define pb push_back
#define mp make_pair
using namespace std;


char s[122222];
int n, m,i;
pair <char, int> a[122222];
int range[122222];
int sum[122222];

long long call() {
    //manachar algorithm
    int center = 1;
    range[1] = 1;

    a[0] = mp('#', 0);
    a[m + 1] = mp('@', 0);

    for(i=2;i<=m;i++) {
        range[i] = 1;
        if (center + range[center] - 1 >= i) {
            range[i] = range[center * 2 - i];
            if (i + range[i] < center + range[center]) continue;
            else range[i] = center + range[center] - i;
        }

        while (a[i - range[i]] == a[i + range[i]]) range[i]++;
        center = i;
    }
    //end of manachar algorithm

    long long res = 0;
    sum[0] = 0;
    for(i=1;i<=m;i++)
        sum[i] = a[i].second + sum[i - 1];


    for(i=1;i<=m;i++) {

        res += (long long) (a[i].second + 1) * (a[i].second) / 2;

        if (range[i] > 1) {
            res -= (a[i].second + 1)/2;
            int u = i - range[i] + 1, v = i + range[i] - 1;
            res += (sum[v] - sum[u - 1] + 1)/2;
            if (a[u - 1].first == a[v + 1].first) res += min(a[u - 1].second, a[v + 1].second);
        }
        else
        if (a[i - 1].first == a[i + 1].first) res += min(a[i-1].second, a[i + 1].second);
    }

    return res;
}

int main() {
    int ntest;
    scanf("%d\n", &ntest);

    int sum = 0;
    while (ntest --) {
        cin >> m;
        for(i=1;i<=m;i++)
            cin >> a[i].first >> a[i].second;

        cout <<call() << endl;
    }

    return 0;
}
