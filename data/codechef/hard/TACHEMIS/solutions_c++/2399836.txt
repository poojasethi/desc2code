#include<stdio.h>
#include<algorithm>
using namespace std;
long long sum,t,n,i,c,r,im,cnt[1000005],ans[1000005],p[1000005],sum1[1000005];

char s[1000005],ch[100];
int main()
{
    scanf("%lld",&t);
    while(t--)
    {
        scanf("%lld",&n);
        sum=0;
        s[0]='^';
        for(i=1;i<=n;i++)
        {
            scanf("%s %lld",&ch,&cnt[i]);
            s[i]=ch[0];
            ans[i]=(cnt[i]*(cnt[i]+1))/2;
            sum1[i]=sum1[i-1]+cnt[i];
        }
        s[i]='$';
        /*for(i=0;i<=n;i++)
        printf("%c ",s[i]);
        printf("\n\n");*/
        c=0;
        r=0;
        for(i=1;i<=n;i++)
        {
            im=2*c-i;
            if(im<0)
            im=0;
            p[i]=((r>i)?min(p[im],r-i):0);
            if(p[i]!=0)
            ans[i]=ans[i]+sum1[i-1]-sum1[i-p[i]-1];
            // printf("i=%d im=%d t[i]=%c c=%d r=%d\n",i,im,s[i],c,r);
            while(s[i+p[i]+1]==s[i-p[i]-1])
            {
                if(cnt[i+p[i]+1]==cnt[i-p[i]-1])
                {
                    ans[i]=ans[i]+cnt[i+p[i]+1];
                    p[i]++;
                }
                else
                {
                    ans[i]=ans[i]+min(cnt[i-p[i]-1],cnt[i+p[i]+1]);
                    break;
                }
            }
            if(i+p[i]>r)
            {
                c=i;
                r=i+p[i];
            }
        }
        /*for(i=0;i<=n;i++)
        printf("%d ",p[i]);
        printf("\n");

        for(i=0;i<=n;i++)
        printf("%d ",ans[i]);
        printf("\n");*/

        for(i=0;i<=n;i++)
        {
            sum=sum+ans[i];
            p[i]=0;
            ans[i]=0;
            cnt[i]=0;
            s[i]=0;
            sum1[i]=0;
        }
        s[i]=0;
        printf("%lld\n",sum);
    }
    return 0;
}
