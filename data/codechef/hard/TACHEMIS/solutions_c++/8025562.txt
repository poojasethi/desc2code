#include <bits/stdc++.h>

#define fi first
#define se second
#define pb push_back
#define mp make_pair
#define pii pair<int,int>
#define MOD 1000000009
#define ll long long int

using namespace std;

pair<char,int> a[1000006];
int p[1000006],f[1000006];

void solve() {
	int n,i,x,c,r,ir;
	char ch;
	ll ans;
	cin>>n;
	a[0]=mp('$',0);
	f[0]=0;
	for(i=1;i<=n;i++) {
		cin>>ch>>x;
		a[i]=mp(ch,x);
		f[i]=f[i-1]+x;
	}
	a[i]=mp('^',0);
	c=r=0;
	for(i=1;i<=n;i++) {
		ir=2*c-i;
		p[i]=(r>i?min(p[ir],r-i):0);
		while(a[i+1+p[i]]==a[i-1-p[i]])
			p[i]++;
		if(i+p[i]>r) {
			c=i;
			r=i+p[i];
		}
	}
	ans=0;
	for(i=1;i<=n;i++) {
		ans=ans+((ll)a[i].se*(a[i].se+1))/2;
		x=f[i+p[i]]-f[i];
		if(a[i+p[i]+1].fi==a[i-p[i]-1].fi)
			x+=min(a[i+p[i]+1].se,a[i-p[i]-1].se);
		ans+=x;
	}
	printf("%lld\n",ans);
	//for(i=1;i<=n;i++)
	//	cout<<p[i]<<" ";
}

int main() {
	int i,test;
	cin>>test;
	for(i=1;i<=test;i++)
		solve();
	return 0;
}