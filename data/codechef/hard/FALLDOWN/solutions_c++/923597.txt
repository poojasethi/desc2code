#include <cstdio>
#include <algorithm>
using namespace std;
int t,n,m,it,X,P,Q,M,cur,i,j,r,a[2020][2020],f[2020][2020],s[2020],best[2020],mx,mn;
int main() {
  scanf("%d",&t);
  while (t--) {
    scanf("%d%d%d",&n,&m,&it);
    if (it==2) {
      scanf("%d%d%d%d",&X,&P,&Q,&M);
      P%=M; Q%=M; cur=X;
      for (i=0; i<n; i++) for (j=0; j<m; j++) {
        cur=(cur*P+Q)%M;
        a[i][j]=X-cur;
      }
    } else for (i=0; i<n; i++) for (j=0; j<m; j++) scanf("%d",&a[i][j]);
    for (i=0; i<n; i++) {
      s[0]=a[i][0];
      for (j=1; j<m; j++) s[j]=s[j-1]+a[i][j];
      mx=-2000000000;
      for (j=m-1; j>=0; j--) {
        mx=max(mx,s[j]);
        best[j]=f[i][j]+a[i][j]+mx-s[j];
        if (j<m-1) best[j]=max(best[j],best[j+1]+a[i][j]);
      }
      //for (j=0; j<m; j++) printf("%d ",best[j]); puts("b");
      for (mn=j=0; j<m; j++) {
        f[i+1][j]=best[j];
        if (j>0) f[i+1][j]+=s[j-1]-mn;
        mn=min(mn,s[j]);
      }
      //for (j=0; j<m; j++) printf("%d ",f[i+1][j]); puts("f");
      mn=0;
      for (j=0; j<m; j++) {
        best[j]=f[i][j]+a[i][j];
        if (j>0) {
          best[j]+=s[j-1]-mn;
          best[j]=max(best[j],best[j-1]+a[i][j]);
        }
        mn=min(mn,s[j]);
      }
      //for (j=0; j<m; j++) printf("%d ",best[j]); puts("b2");
      mx=s[m-1];
      for (j=m-1; j>=0; j--) {
        mx=max(mx,s[j]);
        cur=best[j];
        if (j<m-1) cur+=mx-s[j];
        f[i+1][j]=max(f[i+1][j],cur);
      }
      //for (j=0; j<m; j++) printf("%d ",f[i+1][j]); puts("f2");
    }
    r=f[n][0];
    for (j=1; j<m; j++) if (f[n][j]>r) r=f[n][j];
    printf("%d\n",r);
  }
  return 0;
}
