#include<iostream>
#include<map>
#include<vector>
#define pb push_back
#define mapiter map <long long int,long long int > ::iterator
using namespace std;
const long long int md=1000000007LL;
long long int pw(long long int a,long long int b,long long int N)
{
	int tvar=0;
	a=a%N;
	//cout<<"a "<<a<<endl;
	vector< long long int > tv;
	tv.pb(a);long long int a1=(a*a)%N;
	if(b==0) return 1%N;
	else 
	{
	//cout<<"A1 "<<a1<<endl;
	int flag=1;
	while(flag)
	{
		if(a1==0)
		{
			tv.pb(a1);
			if(b>=tv.size())
			 	return 0;
			else
				return tv[b-1];
		}
		tv.pb(a1);
		a1=a1*a%N;
		//cout<<"a1 "<<a1<<endl;
		flag=1;
		for(int i=0;i<tv.size();i++)
		{	
			if(a1==tv[i])
			{
				tvar=i;flag=0;
				break;
			}
		}
		//getch();		
	}
	if(b>tv.size()) b=((b-1-tv.size())%(tv.size()-tvar))+tvar;
	else b=(b-1)%tv.size();
	//for(int i=0;i<tv.size();i++)
//	{
//		cout<<tv[i]<<" ";
//	}
	return tv[b];
	}
}
 
int main()
{
	//freopen("in.in","r",stdin);
	int t;cin>>t;
	while(t--)
	{
	long long int power,upper,N,m;
	cin>>upper>>power>>m>>N;long long int n=upper;
	map <long long int ,long long int > am;
	n=n%N;
	for(int i=0;i<=n;i++)
	{
		
		long long int tint=i%N;
		long long int temp =pw(tint,power,N);
		am[temp]++;
	}
	n=upper/N;
	//cout<<"n is "<<n<<endl;
	for(int i=0;i<N;i++)
	{
		long long int tint=i%N;
		long long int temp =pw(tint,power,N);
		am[temp]+=n;
		am[temp]=am[temp]%md;
	}
//	for(mapiter it=am.begin();it!=am.end();it++)
//	{
//		cout<<it->first<<" "<<it->second<<endl;
//	}
	long long int count=0;
	for(mapiter it1=am.begin();it1!=am.end();it1++)
	{
		for(mapiter it2=am.begin();it2!=am.end();it2++)
		{
			for(mapiter it3=am.begin();it3!=am.end();it3++)
			{
				if(((it1->first+it2->first+it3->first)%N)==m)
				{
					long long int tcount=it1->second*it2->second;
					tcount=tcount%md;
					tcount=tcount*it3->second;
					tcount=tcount%md;
					count=count+tcount;
					count=count%md;
				}
			}
		}
	}
	cout<<count<<endl;
	}
	return 0;
} 