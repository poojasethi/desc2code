#include<iostream>
#include<stdio.h>
#define For(i,a,b) for(i=a;i<b;i++)
using namespace std;
int p;
char region[105][105];
int value[105][105];
int row[105][105];
int power(int a,int b)
{
	int f=1;
	while(b)
	{
		if(b%2==1)
			f=(f*a)%p;
		a=(a*a)%p;
		b/=2;
	}
	return f;
}
int main()
{
    int t,n,m,I,F,i,j,k,max,max_area,temp,temp_area;
    scanf("%d",&t);
    while(t--)
    {
        I=0;
        F=0;
        scanf("%d%d",&n,&m);
        For(i,0,n)
            scanf("%s",region[i]);
        scanf("%d",&p);
        For(i,0,n)
            For(j,0,m)
            {
                if(region[i][j]=='F')
				{
					F++;
					value[i][j]=(-1)*power(F,i+j);
				}
				else
				{
					I++;
					value[i][j]=power(I,i+j);
				}
            }
        For(i,0,n)
        {
            row[i][0]=value[i][0];
            For(j,1,m)
                row[i][j]=row[i][j-1]+value[i][j];
        }
        max=0;
        max_area=0;
        For(i,0,m)
            For(j,i,m)
            {
                temp=0;
                temp_area=0;
                For(k,0,n)
                {
                    temp+=row[k][j]-row[k][i]+value[k][i];
                    temp_area+=j-i+1;
                    if(temp<0)
                    {
                            temp=0;
                            temp_area=0;
                    }
                    else if(temp>=max)
                    {
                        if(temp>max)
                        {
                            max=temp;
                            max_area=temp_area;
                        }
                        else if(temp_area>max_area)
                            max_area=temp_area;
                    }
                    //cout<<"temp= "<<temp<<"  temp_area= "<<temp_area<<endl;
                }
            }
        printf("%d\n",max_area);
    }
    return 0;
}
