#include <bits/stdc++.h>
#define rf freopen("inp.in", "r", stdin)
using namespace std;
const int MAX = 100050;
 
int N, D, E[MAX];
vector < int > adj[MAX];
int mark[MAX], num[MAX], mx = MAX;
pair < int, int > DP[MAX];
int mxlvl = -1;
 
void dfs(int u, int p){
 	DP[u].first = DP[u].second = 0;
    for(auto v: adj[u]){ 
	    if(v == p) continue;
	    dfs(v, u);
	    if(DP[v].first + 1 >= DP[u].first){
	    	DP[u].second = DP[u].first;
	    	DP[u].first  = DP[v].first + 1;
	    }
	    else if(DP[v].first + 1 > DP[u].second)
	    	DP[u].second = DP[v].first + 1;
	}
}

void dfs2(int u, int p, int val){
	E[u] = max(val, DP[u].first);
	for(auto v : adj[u]){
		if(v == p) continue;
		if(DP[u].first == DP[v].first + 1) 
		dfs2(v, u, max(val, DP[u].second) + 1);
		else
		dfs2(v, u, max(val, DP[u].first)  + 1);
	}
}
 
pair < int, int > get_center(){
 
    dfs(0, -1);
    dfs2(0, -1, 0);
    
    pair < int , int > res;
    res.first = res.second = -1;
    int val = 1e8;
    
    for(int i = 0 ; i < N ; i++){
    	if(E[i] < val) val = E[i];
    	if(E[i] > D) D = E[i];
    }
    
    for(int i = 0 ; i < N ; i++){
    	if(E[i] == val){
    		if(res.first == -1) res.first = i;
    		else res.second = i;
    	}
    }

    return res;
}
 
void dfs3(int u, int p, int d, int lvl = 1){
 
    if(d == 0){
    	mark[u] = 1;
    	if( lvl < mx ){
    		mxlvl = lvl;
    		lvl = mx;
    	}
    	return;
    }
 
    for(auto& v: adj[u]){ 
    	if(v != p){
          dfs3(v, u, d - 1, lvl + 1);
          mark[u] |= mark[v];
          if(mark[v]) num[u]++;
        }
    }
 
    if(num[u] >= 2 and lvl < mx){
    	mx = lvl;
    	mxlvl = lvl;
    }
 
}
 
 
int main(){
 
	int TEST;
	scanf("%d",&TEST);
 
	while(TEST--){
	    
	    scanf("%d", &N);
	    D = 0;
	    for(int i = 0; i <= N ; i++) adj[i].clear();
	    
	    memset(mark, 0, sizeof mark);
	    memset(num, 0, sizeof num);
	    memset(E, 0, sizeof E);

	    int a = 0, b = 0, ans = 0, ff = 0, gg = 0;
	    
	    for(int i = 1 ; i < N; i++){
	        scanf("%d", &a);
	        adj[i].push_back(a);
	        adj[a].push_back(i);
	    }
 
	    pair < int, int > cen = get_center();
	    
	    if(cen.second == -1){
 
	        int cnt = 0;
	        
	        for(auto& v: adj[cen.first]){
	        	mx = MAX;
	            dfs3(v, cen.first, D / 2 - 1);
	            if(mark[v]) cnt++, ans += mxlvl;
	        }
 
	        if(cnt >= 3) printf("1\n");
	        else printf("%d\n",ans + 1);
	    }
	    else{
 
	        int u1 = cen.first, u2 = cen.second;
	        a = 0, b = 0;
 
	       	for(auto& v: adj[u1]){
	       		if(v != u2){
	       			mx = MAX;
	       			dfs3(v, u1, D / 2 - 1);
	       			if(mark[v]) a++, ff += mxlvl;
	       		}
	       	}
 
	        
	        for(auto& v: adj[u2]){
	       		if(v != u1){
	       			mx = MAX;
	       			dfs3(v, u2, D / 2 - 1);
	       			if(mark[v]) b++, gg += mxlvl;
	       		}
	       	}
 
 
	        if(a >= 2 and b >= 2) printf("2\n");
	        else if( a == 1 and b == 1) printf("%d\n", ff + gg + 2);
	        else if( a == 1 ) printf("%d\n", ff + 2);
	        else printf("%d\n", gg + 2);
	        
	    }
	}
} 