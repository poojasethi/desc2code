#include <cstdio>
typedef long long LL;
LL mod_exp(LL a,LL b,int p)
{
    LL res=1;
    while(b){
        if(b&1) res=res*a%p;
        a=a*a%p;
        b>>=1;
    }
    return res;
}
int main()
{
    int t;
    scanf("%d",&t);
    while(t--){
        int k,p;
        LL l,r;
        scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
        LL ans;
        LL m=r-l;
        if(k%p==0){
            ans=1;
        }
        else {
            LL x=mod_exp(k,mod_exp(2,l,p-1),p);
            if(x==1) {
                ans=mod_exp(2,m+1,p);
            }
            else ans=(mod_exp(x,mod_exp(2,m+1,p-1),p)-1)*mod_exp(x-1,p-2,p)%p;
        }
        if(k&1){
            if(p==2) ans=0;
            else {
                ans=ans*mod_exp(mod_exp(2,m,p),p-2,p)%p;
            }
        }
        while(ans<0) ans+=p;
        printf("%I64d\n",ans);
    }
}