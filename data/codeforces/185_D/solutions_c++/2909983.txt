#include<cstdio>
typedef long long ll;
int quick(int a,ll b,int p){
	int ans=1;
	for (;b;b>>=1){
		if (b&1) ans=ans*ll(a)%p;
		a=a*ll(a)%p;
	}
	return ans;
}
int main(){
	int t,k,p,now;
	ll l,r,ans;
	for (scanf("%d",&t);t;t--){
		scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
		if (p==2) {printf("%d\n",k%2==0); continue;}
		now=k%p?quick(k,quick(2,l,p-1),p):0;
		if (now==1) ans=quick(2,r-l+1,p); else
		if (now==0) ans=1; else
			ans=quick(now-1,p-2,p)*ll(quick(now,quick(2,r-l+1,p-1),p)-1)%p;
		if (k&1) ans=ans*ll(quick(quick(2,r-l,p),p-2,p))%p;
		printf("%d\n",ans);
	}
	return 0;
}
