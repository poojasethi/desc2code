#include<cstdio>
#include<cstring>
#include<cstdlib>
#include<algorithm>
using namespace std ;
typedef long long LL ;

LL t, k, l, r, P ;
LL mod, flag ;

LL ksm(LL x, LL t)
{
	if(!x) return 0 ;
	if(!t) return 1 ;
	LL tmp = ksm(x, t/2) ;
	tmp = tmp*tmp%mod ;
	if(t&1) tmp = tmp*x%mod ;
	return tmp ;
}

int main()
{
	LL i, j, tmp ;
	scanf("%I64d", &t) ;
	while(t--)
	{
		scanf("%I64d %I64d %I64d %I64d", &k, &l, &r, &P) ;
			flag = k&1 ;
			k %= P ;
			mod = P-1, tmp = ksm(2, l) ;
			mod = P, k = ksm(k, tmp) ;
			if(k == 1)
				tmp = ksm(2, r-l+1) ;
			else 
			{	
				mod = P-1, tmp = ksm(2, r-l+1) ;
				mod = P ;
				tmp = (ksm(k, tmp)%P-1+P)*ksm(k+P-1, P-2)%P ;
			}	
            if(flag) 
				tmp = tmp*ksm(ksm(2, r-l), P-2)%P ;
			printf("%I64d\n", tmp) ;
	}
	//system("pause") ;
	return 0 ;
}

					 			  	  		   		  		