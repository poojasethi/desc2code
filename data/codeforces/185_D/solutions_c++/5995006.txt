#include<cstdio>
typedef long long ll;
int t;
ll pow(ll a,ll b,ll p){
  a%=p;
  ll res=1;
  for (;b;b>>=1,a=a*a%p) if (b&1) res=res*a%p;
  return res;
}
ll f(const ll k,const ll x,const ll a,const ll p){
  return pow(k,pow(x,a,p-1),p);
}
int main(){
  scanf("%d",&t);
  for (ll k,l,r,p;t;t--){
    scanf("%I64d%I64d%I64d%I64d",&k,&l,&r,&p);
    ll s1=k%p?(1-f(k,2,r+1,p)+p)%p:p-1,s2=k%p?(1-f(k,2,l,p)+p)%p:p-1,g=k&1?pow(pow(2,r-l,p),p-2,p):1;
    printf("%I64d\n",s2?(s1*pow(s2,p-2,p)%p*g%p+p)%p:k&1?2%p:pow(2,r-l+1,p));
  }
}
