#include<cstdio>
#define ll long long

ll K,L,R,P,N,Ans,_K;

int TestCase;

ll Quick(ll A,ll B,ll M)
{
	ll C(1);
	for(;B;B>>=1)
	{
		if(B&1)C=(C*A)%M;
		A=(A*A)%M;
	}
	return C;
}

int main()
{
	for(scanf("%d",&TestCase);TestCase--;)
	{
		scanf("%I64d%I64d%I64d%I64d",&K,&L,&R,&P);
		N=R-L+1;
		if(!(K%P))
		{
			if(K&1)
			{
				Ans=Quick(Quick(2,P-2,P),N-1,P);
				printf("%I64d\n",Ans);
			}
			else printf("1\n");
		}
		else
		{
			_K=K;
			if(P==2)printf("0\n");
			else
			{
				K=Quick(K,Quick(2,L,P-1),P);
				if(K==1)Ans=Quick(2,N,P);
				else
				{
					Ans=Quick(K,Quick(2,N,P-1),P)-1;
					Ans=(Ans*Quick(K-1,P-2,P))%P;
				}
				if(_K&1)
				{
					Ans=(Ans*Quick(Quick(2,P-2,P),N-1,P))%P;
					printf("%I64d\n",Ans);
				}
				else printf("%I64d\n",Ans);
			}
		}
	}
	return 0;
}
