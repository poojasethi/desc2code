#include<iostream>
#include<cstdlib>
#include<cstdio>
#include<cmath>
#include<cstring>
#include<algorithm>
#define fi(i,a,b) for (int i=a;i<=b;i++)
#define fd(i,a,b) for (int i=a;i>=b;i--)
#define mms(a,b) memset(a,b,sizeof(a));
#define mmc(a,b) memcpy(a,b,sizeof(b));
#define LL long long
using namespace std;

LL k,l,r,p,h,ans;
int t;

LL pow(LL a,LL b,LL md)
{
	LL t=1;
	while (b)
	{
		if (b&1) t=(t*a)%md;
		a=a*a%md;
		b>>=1;
	}
	return t;
}

int main()
{
	//freopen("input.txt","r",stdin);
	scanf("%d",&t);
	fi(i,1,t)
	{
		cin >> k >> l >> r >> p;
		h=pow(k,pow(2,l,p-1)+p-1,p);
		if (h==0) ans=1;
		else if (h==1) ans=pow(2,r-l+1,p);
		else ans=(pow(k,pow(2,r+1,p-1)+p-1,p)+p-1)*pow(h-1,p-2,p)%p;
		if (k&1) ans*=pow(pow(2,r-l,p),p-2,p);
		ans%=p;
		cout << ans << endl;
	}	
	return 0;
}
