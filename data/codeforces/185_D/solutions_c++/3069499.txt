#include<cstdio>
#include<algorithm>
using namespace std;
int exp_mod(int a,long long b,int m)
{
    int ans=1;
    while(b)
    {
        if(b&1)ans=1LL*ans*a%m;
        a=1LL*a*a%m;
        b>>=1;
    }
    return ans;
}
int main()
{
    int T;
    scanf("%d",&T);
    while(T--)
    {
        int k,p;long long l,r;
        scanf("%d %I64d %I64d %d",&k,&l,&r,&p);
        if(p==2)printf("%d\n",(k&1)^1);
        else
        {
            int x=exp_mod(k,exp_mod(2,l,p-1),p);
            long long n=r-l;
            int ans;
            if(x==1)ans=exp_mod(2,n+1,p);
            else ans=1LL*(exp_mod(x,exp_mod(2,n+1,p-1),p)-1)*exp_mod(x-1,p-2,p)%p;
            if(k%p==0)ans=1;
            if(k&1)ans=1LL*ans*exp_mod(2,((-n)%(p-1)+p-1)%(p-1),p)%p;
            if(ans<0)ans+=p;
            printf("%d\n",ans);
        }
    }
}
