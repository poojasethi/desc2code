#include <iostream>
using namespace std;
#define rep(i,n) for (int i=0;i<n;i++)
typedef long long ll;
int _;ll k,l,r,p;
ll pow(ll a,ll b,ll p) {
	ll ans=1;
	for (int i=0;b>>i;i++) {
		if ((b>>i)&1) (ans*=a)%=p;
		(a*=a)%=p;
	}
	return ans%p;
	
}
ll q(ll a,ll c) {
	if (a%p) return (pow(a,pow(2,c,p-1),p)+p-1)%p;
	else return p-1;
}
#define rev(a) (pow(a,p-2,p))
ll solve(ll k,ll l,ll r,ll p) {
	ll a=q(k,l);
	if (a) return q(a+1,r-l+1)*rev(a)%p*((k&1)?rev(pow(2,r-l,p)):1)%p;
	else return ((k&1)?2:pow(2,r-l+1,p))%p;
}
int main() {
	cin>>_;
	rep(__,_) {
		cin>>k>>l>>r>>p;
		cout<<solve(k,l,r,p)<<endl;
	}
}