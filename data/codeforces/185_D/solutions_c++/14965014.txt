#include <stdio.h>
#include <algorithm>
using namespace std;
int t;
long long k,l,r,p,a,b,h;
long long ksm(long long x,long long y,long long mo){
	long long k=1;
	for(;y;y>>=1){
		if(y&1)k=1ll*k*x%mo;
		x=1ll*x*x%mo; 
	}
	return k;
}
int main(){
	scanf("%d",&t);
	for(;t;t--){
		scanf("%I64d%I64d%I64d%I64d",&k,&l,&r,&p);
		if(p==2){if(k&1)printf("0\n");else printf("1\n");continue;}
		if(k==1){printf("%I64d\n",2%p);continue;}
		h=1;
		if(k&1)h=ksm(ksm(2,p-2,p),r-l,p);
		if(k%p==0){
			printf("%I64d\n",h);continue;
		}
		else {
			a=ksm(k,ksm(2,r+1,p-1),p)-1;
			b=ksm(k,ksm(2,l,p-1),p)-1;
			if(!b)printf("%I64d\n",ksm(2,r-l+1,p)*h%p);
			else printf("%I64d\n",h*a%p*ksm(b,p-2,p)%p);
		}
	}
	
	return 0;
}