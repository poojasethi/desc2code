#include<iostream>
using namespace std;
#define ll long long
ll pow(ll a,ll b,ll p){ll r=1;for(;b;b>>=1,a=a*a%p) if(b&1) r=r*a%p;return r;}
void extend_gcd(ll &x,ll &y,ll a,ll b){
    if(b==0){x=1,y=0;return;}
    extend_gcd(x,y,b,a%b); 
    x-=a/b*y;y^=x,x^=y,y^=x;
}
int main(){
    int T;
    ll k,l,r,p,x,y,t,tt;
    cin>>T;
    while(T--){
        cin>>k>>l>>r>>p;
        if(k%p&&pow(k,pow(2,l,p-1),p)==1)
            t=pow(2,r-l+1,p),tt=k%2?pow(2,r-l,p):1;
        else{
            t=k%p?pow(k,pow(2,r+1,p-1),p)+p-1:p-1;
            tt=k%p?pow(k,pow(2,l,p-1),p)+p-1:p-1;
            if(k%2) tt=tt*pow(2,r-l,p)%p;
        }
        extend_gcd(x,y,tt,p);
        cout<<(t*x%p+p)%p<<endl;
    }
}
