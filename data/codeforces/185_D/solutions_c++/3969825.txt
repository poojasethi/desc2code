#include<cstdio>
#include<cstring>
#include<cstdlib>
#include<algorithm>
#define int64 long long
using namespace std;
int T,k,p;
int64 l,r,ans,x,y;
int64 pow(int64 x,int64 y,int64 p){
	int64 res=1;
	while(y){
		if(y&1)res=res*x%p;
		x=x*x%p;
		y/=2;
	}
	return res;
}
int main(){
	for(scanf("%d",&T);T--;){
		scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
		if(p==2)printf("%d\n",1-(k&1));
		else{
			if(k%p==0)x=y=p-1;
			else x=pow(k,pow(2,r+1,p-1),p)-1,y=pow(k,pow(2,l,p-1),p)-1;
			if(!y) ans=pow(2,r-l+1,p);
			else ans=x*pow(y,p-2,p)%p;
			printf("%I64d\n",ans*(k&1?pow(2,(r-l)%(p-1)*(p-2)%(p-1),p):1)%p);
		}
	}
}
