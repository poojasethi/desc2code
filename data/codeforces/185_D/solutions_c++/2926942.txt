#include <cstring>
#include <cstdio>
#include <iostream>
using namespace std;

long long k,L,R,p,d;
		
long long pow(long long x, long long p, long long mod)
{
	long long res=1;
	for (;p;p>>=1)
	{
		if (p&1) res=res*x%mod;
		x=x*x%mod;
	}
	return res;
}

long long f(long long x)
{
	if (k%p==0) return 0;
	return pow(k,pow(2,x,p-1),p);
}

long long inv(long long x)
{
	return pow(x,p-2,p);
}

int main()
{
	int t;
	scanf("%d",&t);
	while (t--)
	{
		cin>>k>>L>>R>>p;
		if (k&1) d=inv(pow(2,R-L,p)); else d=1;
		if (p==2)
			if (k&1) printf("0\n"); else printf("1\n");
		else 
			if (f(L)-1) 
				cout<<(f(R+1)-1)*inv(f(L)-1)%p*d%p<<endl;
			else cout<<pow(2,R-L+1,p)*d%p<<endl;
	}
	//for (;;);
}
