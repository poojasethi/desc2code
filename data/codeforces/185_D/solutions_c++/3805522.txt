#include <cstdio>
#include <cstdlib>
#include <cstring>
#include <iostream>
using namespace std;

typedef long long LL;

LL k, l, r, p;

LL Pow (LL x, LL y, LL mod)
{
	LL ret = 1, base = x%mod;
	while (y)
	{
		if (y&1) ret = ret*base%mod;
		y >>= 1; base = base*base%mod;
	}
	return ret;
}

LL Check (LL k, LL x)
{
	if (!(k%p)) return 0;
	return Pow (k, Pow (2, x, p-1), p);
}

LL main_ ()
{
	scanf ("%I64d%I64d%I64d%I64d", &k, &l, &r, &p);
	if (p == 2) return (k&1? 0: 1);
	int t = Check (k, l);
	if (t == 1) return Pow (2, k&1? 1: r-l+1, p);
	LL ret = (Check (k, r+1)-1) * Pow (t-1, p-2, p) % p;
	if (k & 1) ret *= Pow (Pow (2, r-l, p), p-2, p);
	return ret % p;
}

int main ()
{
	int T; scanf ("%d", &T);
	while (T--) printf ("%d\n", (int) main_ ());
	return 0;
}