#include<cstdio>
#include<algorithm>
#include<string>
#include<cstring>
#include<cmath>
#include<map>
#include<queue>
#include<iostream>
#define LL long long
#define INF 99999999
#define EPS 1e-9
//using namespace std;
LL K,L,R,P,N,Tem,_K,Case;
LL pow(LL A,LL B,LL M){
	LL C=1;
	for(;B;B>>=1){
		if(B&1)C=(C*A)%M;
		A=(A*A)%M;
	}
	return C;
}
int main(){
	for(scanf("%I64d",&Case);Case--;){
		scanf("%I64d%I64d%I64d%I64d",&K,&L,&R,&P);
		N=R-L+1;
		if(K%P==0){
			if(K&1)
				printf("%I64d",pow(pow(2,N-1,P),P-2,P));
			else
				printf("1");
		}else{
			LL K1=K;
			if(P==2)
				printf("0");
			else{
				K=pow(K,pow(2,L,P-1),P);
				if(K==1) 
					Tem=pow(2,N,P);
				else
					Tem=((pow(K,pow(2,N,P-1),P)-1)*pow(K-1,P-2,P))%P;
				
				if(K1&1) Tem=Tem*(pow(pow(2,N-1,P),P-2,P))%P;
				printf("%I64d",Tem);
			}
		}
		printf("\n");
	}
}

	 	 	 		 			   	 			 				