//185D
#include <iostream>
#include <cstdio>
using namespace std;
int expMod(int a,long long b,int c){
	if(!b)return 1;
	int res=expMod(a,b>>1,c);
	res=res*(long long)res%c;
	if(b&1)
		res=res*(long long)a%c;
	return res;
}
int main(){
	int t;
	scanf("%d",&t);
	while(t--){
		int k,p;
		long long l,r;
		scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
		if(p==2){
			printf("%d\n",!(k&1));
			continue;
		}
		int tmp=expMod(k,expMod(2,l,p-1)+p-1,p),res;
		if(!tmp){
			res=1;
		}else if(tmp==1){
			res=expMod(2,r-l+1,p);
		}else
			res=(expMod(tmp,expMod(2,r-l+1,p-1)+p-1,p)+p-1)*(long long)expMod(tmp-1,p-2,p)%p;
		if(k&1)
			res=res*(long long)expMod((p+1)>>1,r-l,p)%p;
		printf("%d\n",res);
	}
	return 0;
}
