#include<bits/stdc++.h>
using namespace std;

int nq,k,mod;
long long l,r,ans;

long long fpow(long long i,long long j,int mod1)
{long long ret=1;
 while(j)
 {	if(j&1) ret=ret*i%mod1;
 	i=i*i%mod1;
 	j/=2;
 }
 return ret;
}

long long calc(long long n)
{if(n<0) return 1;
 if(k%mod==1) return fpow(2,n,mod);
 if(k%mod==0) return 1;
 return (fpow(k,fpow(2,n,mod-1),mod)-1)*fpow(k-1,mod-2,mod)%mod;
}

int main()
{int i,j,q,t;

 scanf("%d",&nq);
 for(q=1;q<=nq;q++)
 {	scanf("%d%I64d%I64d%d",&k,&l,&r,&mod);
 	t=k;
 	if(k%mod==0)
		k=0;
	else
		k=fpow(k,fpow(2,l,mod-1),mod);
	ans=calc(r-l+1);
 	if(t%2==1)
 	{	if(mod==2)
 			ans=0;
 		else
	 		ans=ans*fpow(fpow(2,r-l,mod),mod-2,mod)%mod;
	}
	printf("%d\n",(ans+mod)%mod);	
 }
 return 0;
}