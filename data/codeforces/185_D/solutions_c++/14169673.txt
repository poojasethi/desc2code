#include<cstdio>
#define ll long long
#define f(x) (k%p?pow(k,pow(2,x,p-1),p):0LL)
#define rev(x) pow(x,p-2,p)
int t,k,p,a; ll L,R;
ll pow(ll x,ll y,int p){ll res=1;x=(x+p)%p;for(;y;y>>=1){if(y&1)res=res*x%p;x=x*x%p;}return res;}
int main()
{
	scanf("%d",&t);
	while (t--) scanf("%d%I64d%I64d%d",&k,&L,&R,&p),
		printf("%I64d\n",p<3?k&1?0:1:((f(L)-1?(f(R+1)-1)*rev(f(L)-1)%p:pow(2,R-L+1,p))*(k&1?rev(pow(2,R-L,p)):1)%p+p)%p);
	return 0;
}
