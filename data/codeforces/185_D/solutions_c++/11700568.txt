#include<cstdio>
int x,k,p,ans,T;
long long l,r;
inline int pow(long long x,long long y,int p){
	long long res=1;
	for(;y;y>>=1,x=x*x%p)if(y&1)res=res*x%p;
	return res;
}
inline int spow(long long x,long long y){
	if(x%p==0)return p-1;
	return (pow(x,pow(2,y,p-1),p)+p-1)%p;
}
int main(){
	for(scanf("%d",&T);T--;){
		scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
		if(p==2)
			ans=k&1^1;
		else if(x=spow(k,l),!x)
			ans=k&1?2:pow(2,r-l+1,p);
		else{
			ans=(long long)spow(k,r+1)*pow(x,p-2,p)%p;
			if(k&1)ans=(long long)ans*pow(pow(2,r-l,p),p-2,p)%p;
		}
		printf("%d\n",ans);
	}
	return 0;
}