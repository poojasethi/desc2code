#include<iostream>
using namespace std;
__int64 k,l,r,p,t,a,b,ans;
__int64 pow(__int64 a,__int64 b,__int64 p)
{
	if(!a&&!b) return 0;
	__int64 c=1;
	for(;b;b>>=1)
	{
		if(b&1) c=c*a%p;
		a=a*a%p;
	}
	return c;
}
int main()
{
	ios::sync_with_stdio(false);
	cin>>t;
	while(t--)
	{
		cin>>k>>l>>r>>p;
		if(k==1) {cout<<2%p<<"\n"; continue;}
		ans=k&1?pow(pow(2,p-2,p),r-l,p):1;
		k%=p;
		a=pow(k,pow(2,r+1,p-1),p),b=pow(k,pow(2,l,p-1),p);
		if(b!=1) ans=ans*(a-1)%p*pow(b-1,p-2,p)%p;
		else ans=ans*pow(2,r-l+1,p)%p;
		cout<<(ans+p)%p<<"\n";
	}
}