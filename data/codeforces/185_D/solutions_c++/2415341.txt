#include<cstdio>
#include<cstdlib>
#include<cstring>
#include<iostream>
#include<algorithm>
using namespace std;
typedef long long LL;
int n,m,T;
int k,p;
LL l,r;
int _pow(const int a,const LL l,const int p)
{
	int x=1,y=a;
	for(LL e=l;e>0;e>>=1 )
	{
		if ( e&1 ) x=(LL)x*y%p;
		y=(LL)y*y%p;
	}
	return x;
}
int Gans()
{
	scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
	if ( p==2 ) return (k&1)?0:1;
	if ( k%p==0 ) return (k&1)?_pow((p+1)/2,r-l,p):1;
	int a=_pow(2,l,p-1),A,B;
	A=_pow(k,a,p);
	if ( A==1 ) return (k&1)?2:_pow(2,r-l+1,p);
	a=_pow(2,r-l+1,p-1);
	B=_pow(A,a,p)-1;
	B=(LL)B*_pow(A-1,p-2,p)%p;
	if ( k&1 ) B=(LL)B*_pow((p+1)/2,r-l,p)%p;	
	return B;
}
int main()
{
	for(scanf("%d",&T);T--;) 
		printf("%d\n",Gans());
	return 0;
}