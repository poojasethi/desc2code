#include <cstdio>
#include <algorithm>
using namespace std;
typedef long long ll;

inline ll pow(ll a, ll b, ll md) {
	ll ans = 1;
	for (; b; b>>=1) {
		if (b & 1) ans = ans * a % md;
		a = a * a % md;
	}
	return ans;
}
inline ll inv(ll a, ll md) {
	if (a == 0)
		return 0; else
		return pow(a, md-2, md);
}
inline ll calc(ll k, ll n, ll md) { // k ^ (2 ^ n)
	if (n <= 30)
		return pow(k, 1 << n, md); else
		return pow(k, md-1 + pow(2, n, md-1), md);
}
ll l, r, k, p, ans, Div;
void run() {
	scanf("%I64d%I64d%I64d%I64d", &k, &l, &r, &p);
	if (k == 1)
		printf("%I64d\n", 2 % p);
	else {
		Div = (calc(k ,l, p)-1+p) % p;
		if (Div)
			ans = (calc(k, r+1, p)-1+p) * inv(Div, p) % p; else
			ans = pow(2, r-l+1, p);
		if (k & 1) ans = ans * inv(pow(2, r-l, p), p) % p;
		printf("%I64d\n", ans);
	}
}
int main() {
	int T;
	scanf("%d", &T);
	while (T--) run();
	return 0;
}