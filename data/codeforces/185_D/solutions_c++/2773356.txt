#define LLD "%I64d"

#include<iostream>
#include<algorithm>
#include<cstdio>
#include<cstring>

typedef long long ll;

const int fin=0;

inline ll pow(ll x,ll y,ll p){
  ll e=1;
  while(y){
    if(y&1)e=e*x%p;
    x=x*x%p;
    y>>=1;
  }
  return e;
}
inline ll sol(ll x,ll y,ll p){
  if(x%p==0)return p-1;
  return (pow(x,pow(2,y,p-1),p)+p-1)%p;
}

int main(){
  if(fin){
    freopen("t.in","r",stdin);
    freopen("t.out","w",stdout);
  }
  int T;
  ll k,l,r,p,t,s;
  scanf("%d",&T);
  while(T--){
    scanf(LLD LLD LLD LLD,&k,&l,&r,&p);
    if(p==2)
      s=k-1&1;
    else if(t=sol(k,l,p),!t)
      s=pow(2,k&1?1:(r-l+1),p);
    else{
      if(k&1)t=t*pow(2,r-l,p)%p;
      s=sol(k,r+1,p)*pow(t,p-2,p)%p;
    }
    printf(LLD"\n",s);
  }
  return 0;
}
