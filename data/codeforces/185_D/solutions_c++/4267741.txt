#include<iostream>
#include<cstdio>
#include<cstdlib>
#include<cstring>
#include<cmath>
#include<algorithm>
using namespace std;
typedef long long LL;
LL k,l,r,mod;
LL power(LL p,LL n,LL mod)
{
	LL ans=1;
	for(;n;n>>=1,p=p*p%mod)
		if(n&1)
			ans=ans*p%mod;
	return ans;
}
LL Anti(LL p)
{
	return power(p,mod-2,mod);
}
void print()
{
	if(k==1)
		cout<<2%mod<<endl;
	else if(mod==2)
		cout<<(k&1^1)<<endl;
	else
	{
		LL v1=(power(k,power(2,r+1,mod-1),mod)-1+mod)%mod;
		LL v2=(power(k,power(2,l,mod-1),mod)-1+mod)%mod;
		LL anti=1;
		if(k&1)
			anti=Anti(power(2,r-l,mod));
		if(k%mod==0)
			v1=v2=mod-1;
		if(v2==0)
			cout<<power(2,r-l+1,mod)*anti%mod<<endl;
		else
			cout<<v1*Anti(v2)%mod*anti%mod<<endl;
	}
}
int main()
{
	int test;
	for(scanf("%d",&test);test;test--)
	{
		cin>>k>>l>>r>>mod;
		print();
	}
	return 0;
}