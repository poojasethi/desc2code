#include<iostream>
#include<cstdio>
#include<algorithm>
typedef long long ll;
using namespace std;
ll k,l,r,p,x;
int t;
ll pow(ll x,ll y,ll z)
{
	ll a,b;
	for(a=1,b=x%z;y;)
	{
		if (y%2==1)a=(a*b)%z;
		b=(b*b)%z;
		y/=2;
	}
	a=(a+z)%z;
	return a;
}
ll niyuan(ll x)
{
	return (pow(x,p-2,p));
}
ll qqq(ll k,ll l)
{
	if (k%p==0) return 0;
	return ((pow(k,pow(2,l,p-1),p))%p);
}

int main()
{
//	freopen("1.in","r",stdin);
//	freopen("1.out","w",stdout);
	scanf("%d",&t);
	for(;t--;) 
	{
		scanf("%I64d%I64d%I64d%I64d",&k,&l,&r,&p);	
		x=qqq(k,l);
		//cout<<x<<endl;
		if (x==1)
		printf("%I64d\n",(k&1)?(2%p):pow(2,r-l+1,p));
		else
		printf("%I64d\n",(qqq(x,r-l+1)+p-1)*niyuan((x+p-1)%p)%p*((k&1)?niyuan(pow(2,r-l,p)):1)%p);
	}
}
