#include<stdio.h>
typedef long long ll;
ll pow(ll x,ll p,ll md)
{
	ll ret=1;
	for(;p;p>>=(ll)1,x=x*x%md)if(p&(ll)1)ret=ret*x%md;
	return ret;
}
ll calc(ll k,ll x,ll md)
{
	if(k%md==0)return 0;
	ll i=pow(2,x,md-1);
	return pow(k,i,md);
}
int main()
{
	int T;
	scanf("%d",&T);
	while(T--)
	{
		ll k,l,r,p;
		scanf("%I64d%I64d%I64d%I64d",&k,&l,&r,&p);
		if(p==2)
			puts(k&1?"0":"1");
		else
		{
			ll t=calc(k,l,p)-1;
			if(!t)
			{
				t=r-l+1-(k&1?r-l:0);
				printf("%I64d\n",pow(2,t,p));
			}
			else
			{
				t=(calc(k,r+1,p)-1)*pow(t,p-2,p)%p;
				if(k&1)t=t*(pow(pow(2,r-l,p),p-2,p))%p;
				printf("%I64d\n",t);
			}
		}
	}
	return 0;
}
