#include<cstdio>
#include<cstring>
#include<cmath>
#include<algorithm>
using namespace std;
typedef long long LL;
int pow(int x,LL y,int p){
	int z=1;
	for(;y;y>>=1){
		if(y&1)z=(LL)z*x%p;
		x=(LL)x*x%p;
	}
	return z;
}
int get(int x,LL y,int p){
	int z=pow(2,y,p-1);
	for(int i=1,j=1;i<=y;++i)
		if((j*=2)>=p-1){z+=p-1;break;}
	return pow(x,z,p);
}
int main(){
	int t;scanf("%d",&t);
	for(int i=1;i<=t;++i){
		int k,p;LL l,r;
		scanf("%d%I64d%I64d%d",&k,&l,&r,&p);
		if(p==2){
			if(k&1)puts("0");else puts("1");
			continue;
		}
		int u=(get(k,r+1,p)+p-1)%p;
		int v=(get(k,l,p)+p-1)%p;
		int w=pow(2,r-l+1,p);
		int s=v?(LL)u*pow(v,p-2,p)%p:w;
		if(k&1)s=(LL)2*s*pow(w,p-2,p)%p;
		printf("%d\n",s);
	}
	return 0;
}
