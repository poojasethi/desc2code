#include<cstdio>
#include<iostream>
#include<algorithm>
#include<cstring>
#include<cmath>
#include<map>
#include<vector>
#include<set>
#include<queue>
#include<cstdlib>
using namespace std;
#define rep(i,a,b) for(int (i)=(a);(i)<=(b);(i)++)
#define re(i,a,b) for(int (i)=(a);(i)<(b);i++)
#define repd(i,a,b) for(int (i)=(a);(i)>=(b);(i)--)
#define run(v) for(int (k)=head[v];k;k=nxt[k])
#define clr(a) memset(a,0,sizeof(a))
#define fst first
#define sec second
typedef long long ll;
typedef pair<int,int> pa;
inline int read(){
	int f=1,x=0;char ch=getchar();
	while(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}
	while(ch>='0'&&ch<='9'){x=x*10+ch-'0';ch=getchar();}
	return x*f;
}
void judge(){
	freopen("data.in","r",stdin);
	freopen("data.out","w",stdout);
}
const int N=1e5+5,M=1e2+5,mod=1e9+7;
int n,m,s[M][4],ed,f[505][N],t1[N],t2[N],t3[N];
char ch[N];
void AND(int *a,int *b,int *c,int l,int r){
	if(l==r){
		c[l]=1ll*a[l]*b[l]%mod;return;
	}int mid=(l+r)>>1,s=mid-l+1;
	rep(i,l,mid)a[i]=(a[i]+a[i+s])%mod,b[i]=(b[i]+b[i+s])%mod;
	AND(a,b,c,l,mid);AND(a,b,c,mid+1,r);
	rep(i,l,mid)c[i]=(c[i]+mod-c[i+s])%mod;
}
void OR(int *a,int *b,int *c,int l,int r){
	if(l==r){
		c[l]=1ll*a[l]*b[l]%mod;return;
	}int mid=(l+r)>>1,s=mid-l+1;
	rep(i,mid+1,r)a[i]=(a[i]+a[i-s])%mod,b[i]=(b[i]+b[i-s])%mod;
	OR(a,b,c,l,mid);OR(a,b,c,mid+1,r);
	rep(i,mid+1,r)c[i]=(c[i]+mod-c[i-s])%mod;
}
int solve(int l,int r){
	int tmp=++m;if(l==r){
		if(ch[l]!='?'&&ch[l]<='D'){
			int p=ch[l]-'A',st=0;rep(i,0,n-1)if(s[i][p])st|=(1<<i);
			f[m][st]=1;
		}else if(ch[l]!='?'){
			int p=ch[l]-'a',st=0;rep(i,0,n-1)if(!s[i][p])st|=(1<<i);
			f[m][st]=1;
		}else{
			rep(p,0,3){
				int st=0;rep(i,0,n-1)if(s[i][p])st|=(1<<i);
				f[m][st]++;
			}
			rep(p,0,3){
				int st=0;rep(i,0,n-1)if(!s[i][p])st|=(1<<i);
				f[m][st]++;
			}
		}return m;
	}
	int num=0,p=0;
	rep(i,l,r){
		if(ch[i]=='(')++num;else if(ch[i]==')')num--;else
		if(!num){p=i;break;}
	}
	int x=solve(l+1,p-2),y=solve(p+2,r-1);
	if(ch[p]=='|')OR(f[x],f[y],f[tmp],0,(1<<n)-1);else
	if(ch[p]=='&')AND(f[x],f[y],f[tmp],0,(1<<n)-1);else{
		rep(i,0,(1<<n)-1)t1[i]=f[x][i],t2[i]=f[y][i],t3[i]=0;
		AND(t1,t2,t3,0,(1<<n)-1);
		OR(f[x],f[y],f[tmp],0,(1<<n)-1);
		rep(i,0,(1<<n)-1)f[tmp][i]=(f[tmp][i]+t3[i])%mod;
	}
	return tmp;
}
int main(){
	scanf("%s",ch);int len=strlen(ch);n=read();
	re(i,0,n){
		rep(j,0,3)s[i][j]=read();
		int x=read();
		if(x)ed|=1<<i;
	}
	int p=solve(0,len-1);
	printf("%d",f[p][ed]);
}
